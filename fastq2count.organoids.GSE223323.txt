#This is a pared down version of the original version created by atorang

#install anaconda 
conda create -n mouseGenomes python=3.6

#open environment 
Conda activate mouseGenomes

#install relevant packages 
conda install -c bioconda samtools=1.7
conda install -c bioconda cutadapt=1.18
conda install -c bioconda fastqc=0.11.9
conda install -c bioconda star=2.7.4a
conda install -c bioconda rsem=1.3.3
conda install -c bioconda subread=2.0.1
conda install -c bioconda multiqc=1.9

# mapping with STAR-------------------
cd /Users/colinbirkenstock/Desktop/mouseCMS_Scripts
mkdir genome
cd genome
wget ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M25/GRCm38.primary_assembly.genome.fa.gz
wget ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M25/gencode.vM25.primary_assembly.annotation.gtf.gz
gunzip GRCm38.primary_assembly.genome.fa.gz
gunzip gencode.vM25.primary_assembly.annotation.gtf.gz
mkdir -p genomeDir


#Creating a genome index
cd /Users/colinbirkenstock/Desktop/mouseCMS_Scripts/fastq
mkdir Cutadapt

output=Cutadapt/
for file in *.gz 
  do
    cutadapt -j 0 -u 12 -q 20 -m 20 \
    -a ATCTCGTATGCCGTCTTCTGCTTG \
    -g GATCGGAAGAGCACACGTCTGAACTCCAGTCAc \
    -b AATGATACGGCGACCACCGAGATCTACACTCTTTCCCTACACGACGCTCTTCCGATCT \
    -o "${output}trim.${file}" \
    ${file}
  done


#Creating a genome index
cd /Users/colinbirkenstock/Desktop/mouseCMS_Scripts/fastq

STAR --runThreadN 8 \
--runMode genomeGenerate \
--genomeDir genome/genomeDir \
--genomeFastaFiles genome/GRCm38.primary_assembly.genome.fa \
--sjdbGTFfile genome/gencode.vM25.primary_assembly.annotation.gtf \
--sjdbOverhang 38 \
--limitGenomeGenerateRAM 25000000000


#Aligning reads
mkdir STAR

for file in Cutadapt/*.gz
do
STAR --genomeDir genome/genomeDir \
--runThreadN 10 \
--readFilesIn ${file} \
--readFilesCommand gunzip -c \
--outFileNamePrefix STAR/${file} \
--outSAMtype None \
--quantMode GeneCounts 
done


#Make count data -------------------------------
brew install parallel

cd data/Merge/STAR/Cutadapt 
ls -1  *ReadsPerGene.out.tab | parallel 'cat {} | sed '1d' | cut -f2 {} > {/.}_clean.txt'
ls -1  *ReadsPerGene.out.tab | head -1 | xargs cut -f1 > genes.txt
paste genes.txt *_clean.txt > output_unstranded.txt
ls -1  *ReadsPerGene.out.tab | parallel 'cat {} | sed '1d' | cut -f3 {} > {/.}_clean.txt'
ls -1  *ReadsPerGene.out.tab | head -1 | xargs cut -f1 > genes.txt
paste genes.txt *_clean.txt > output_stranded.txt
ls -1  *ReadsPerGene.out.tab | parallel 'cat {} | sed '1d' | cut -f4 {} > {/.}_clean.txt'
ls -1  *ReadsPerGene.out.tab | head -1 | xargs cut -f1 > genes.txt
paste genes.txt *_clean.txt > output_Reverse_stranded.txt
ls -1  *ReadsPerGene.out.tab >Colnames.txt